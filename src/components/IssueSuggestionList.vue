<template>
  <suggestion-list
    :suggestions="issueSuggestions"
    :get-current="() => issue as IssueSuggestion"
    :show-customize-form="showIssueSelect"
    @toggle-customize-form="showIssueSelect = $event"
    @select="acceptIssueSuggestion($event as IssueSuggestion)"
  >
    <template #item="suggestion: IssueSuggestion">
      <Issue
        :publicationcode="suggestion.data.publicationcode"
        :issuenumber="suggestion.data.issuenumber" /></template
    ><template #unknown-text>{{ $t("Numéro inconnu") }}</template>
    <template #customize-form>
      <IssueSelect
        @change="
          (issuecode: string|null) => addCustomIssuecodeToIssueSuggestions(issuecode)
        " /></template
    ><template #customize-text> {{ $t("Sélectionner...") }}</template>
  </suggestion-list>
</template>

<script lang="ts" setup>
import { suggestions } from "~/stores/suggestions";
import { IssueSuggestion } from "~dumili-types/suggestions";

const { t: $t } = useI18n();

const showIssueSelect = ref(false);
const suggestionsStore = suggestions();

const issue = computed(() => suggestionsStore.acceptedIssue);
const issueSuggestions = computed(() =>
  suggestionsStore.issueSuggestions.filter(
    (suggestion) => suggestion !== undefined
  )
);

const addCustomIssuecodeToIssueSuggestions = (issuecode: string | null) => {
  if (issuecode) {
    suggestionsStore.issueSuggestions =
      suggestionsStore.issueSuggestions.filter(
        ({ meta }) => meta.source !== "user"
      );
    const [publicationcode, issuenumber] = issuecode.split(" ");
    const userSuggestion = new IssueSuggestion(
      {
        publicationcode,
        issuenumber,
        issuecode,
        coverId: null,
      },
      {
        source: "user",
        isAccepted: false,
      }
    );
    suggestionsStore.issueSuggestions.push(userSuggestion);
    acceptIssueSuggestion(userSuggestion);
  }
};

const acceptIssueSuggestion = (suggestion?: IssueSuggestion) => {
  suggestionsStore.acceptSuggestion(
    suggestionsStore.issueSuggestions,
    (existingSuggestion) =>
      suggestion?.data?.issuecode === existingSuggestion.data.issuecode
  );
  showIssueSelect.value = false;
};
</script>
